<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <title>Client Mobile</title>
    <link rel="stylesheet" href="styles/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Client Mobile</h1>
            <p>Aguardando conexão com o cliente do League of Legends...</p>
        </header>

        <main class="status-grid">
            <div class="card">
                <h2>Servidor Local</h2>
                <div class="status-indicator" id="server-indicator"></div>
                <p id="server-status-text">Parado</p>
                <div class="info-box">
                    <p>Endereço para o App:</p>
                    <strong id="server-address">...</strong>
                </div>
            </div>
            <div class="card">
                <h2>Cliente do LoL (LCU)</h2>
                <div class="status-indicator" id="lcu-indicator"></div>
                <p id="lcu-status-text">Desconectado</p>
                 <div class="info-box">
                    <p>Fila:</p>
                    <strong id="queue-status-text">Inativa</strong>
                </div>
            </div>
        </main>
        
        <section id="controls-section" class="controls-section">
            <div class="card">
                <h2>1. Selecione o Modo de Jogo</h2>
                <div class="form-group">
                    <label for="game-mode-select">Modo:</label>
                    <select id="game-mode-select" class="custom-select" disabled>
                        <optgroup label="Summoner's Rift">
                            <option value="420" data-config-panel="role-select-config">Ranqueada Solo/Duo</option>
                            <option value="400" data-config-panel="role-select-config">Normal Alternada</option>
                            <option value="440" data-config-panel="role-select-config">Ranqueada Flex</option>
                            <option value="490" data-config-panel="swiftplay-config">Swiftplay</option>
                        </optgroup>
                        <optgroup label="Howling Abyss">
                            <option value="450" data-config-panel="aram-config">ARAM</option>
                        </optgroup>
                        <optgroup label="Modos de Jogo Rotativos">
                            <option value="1700" data-config-panel="brawl-config">Brawl</option>
                        </optgroup>
                    </select>
                </div>
                
                <hr class="divider">

                <!-- Painel de Configuração para Modos com Seleção de Rota -->
                <div id="role-select-config" class="config-panel">
                    <h2>2. Configure as Rotas</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label for="primary-role-select">Rota Primária:</label>
                            <select id="primary-role-select" class="custom-select">
                                <option value="MIDDLE">Meio</option>
                                <option value="TOP">Topo</option>
                                <option value="JUNGLE">Selva</option>
                                <option value="BOTTOM">Atirador</option>
                                <option value="UTILITY">Suporte</option>
                                <option value="FILL">Preencher</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="secondary-role-select">Rota Secundária:</label>
                            <select id="secondary-role-select" class="custom-select">
                                <option value="BOTTOM">Atirador</option>
                                <option value="UTILITY">Suporte</option>
                                <option value="MIDDLE">Meio</option>
                                <option value="TOP">Topo</option>
                                <option value="JUNGLE">Selva</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Painel de Configuração para Swiftplay -->
                <div id="swiftplay-config" class="config-panel" style="display: none;">
                    <h2>2. Configure as Seleções</h2>
                    <div class="champion-selection-group">
                        <h3>Primeira Opção</h3>
                        <div class="form-container">
                             <div class="form-group">
                                <label>Campeão:</label>
                                <select id="swiftplay-champ-1" class="custom-select champion-select"></select>
                            </div>
                             <div class="form-group">
                                <label>Rota:</label>
                                <select id="swiftplay-pos-1" class="custom-select position-select">
                                    <option value="TOP">Topo</option>
                                    <option value="JUNGLE">Selva</option>
                                    <option value="MIDDLE">Meio</option>
                                    <option value="BOTTOM">Atirador</option>
                                    <option value="UTILITY">Suporte</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="champion-selection-group">
                        <h3>Segunda Opção</h3>
                        <div class="form-container">
                             <div class="form-group">
                                <label>Campeão:</label>
                                <select id="swiftplay-champ-2" class="custom-select champion-select"></select>
                            </div>
                             <div class="form-group">
                                <label>Rota:</label>
                                <select id="swiftplay-pos-2" class="custom-select position-select">
                                    <option value="BOTTOM">Atirador</option>
                                    <option value="UTILITY">Suporte</option>
                                    <option value="TOP">Topo</option>
                                    <option value="JUNGLE">Selva</option>
                                    <option value="MIDDLE">Meio</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Configuração para ARAM -->
                <div id="aram-config" class="config-panel" style="display: none;">
                    <p>Nenhuma configuração necessária para ARAM.</p>
                </div>

                <!-- Painel de Configuração para Brawl -->
                <div id="brawl-config" class="config-panel" style="display: none;">
                    <h2>2. Configure sua Seleção</h2>
                    <div class="champion-selection-group">
                        <div class="form-container">
                            <div class="form-group">
                                <label>Campeão:</label>
                                <select id="brawl-champ-1" class="custom-select champion-select"></select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="divider">
                
                <button id="start-queue-btn" class="action-btn" disabled>Iniciar Fila</button>
                <button id="leave-queue-btn" class="action-btn leave" style="display: none;">Sair da Fila</button>
            </div>
        </section>

        <section id="ready-check-section" class="ready-check-section" style="display: none;">
            <div class="card">
                <h2>Partida Encontrada!</h2>
                <p class="timer-text" id="ready-check-timer">Tempo restante: 15s</p>
                <div class="button-group">
                    <button id="decline-btn" class="action-btn leave">Recusar</button>
                    <button id="accept-btn" class="action-btn accept">Aceitar</button>
                </div>
            </div>
        </section>

        <footer>
            <p>Mantenha este app aberto enquanto joga.</p>
        </footer>
    </div>

    <script>
        // --- Seletores de Elementos ---
        const allControls = document.querySelectorAll('.custom-select, .action-btn');
        const lcuIndicator = document.getElementById('lcu-indicator');
        const lcuStatusText = document.getElementById('lcu-status-text');
        const serverIndicator = document.getElementById('server-indicator');
        const serverStatusText = document.getElementById('server-status-text');
        const serverAddress = document.getElementById('server-address');
        const controlsSection = document.getElementById('controls-section');
        const readyCheckSection = document.getElementById('ready-check-section');
        const gameModeSelect = document.getElementById('game-mode-select');
        const allConfigPanels = document.querySelectorAll('.config-panel');
        const primaryRoleSelect = document.getElementById('primary-role-select');
        const secondaryRoleSelect = document.getElementById('secondary-role-select');
        const championSelects = document.querySelectorAll('.champion-select');
        const startQueueBtn = document.getElementById('start-queue-btn');
        const leaveQueueBtn = document.getElementById('leave-queue-btn');
        const queueStatusText = document.getElementById('queue-status-text');
        const readyCheckTimer = document.getElementById('ready-check-timer');
        
        let queueTimerInterval = null;
        let queueSeconds = 0;

        // --- Funções de Atualização da UI ---
        function populateChampionSelects(champions) {
            // Log de depuração para ver o que a função recebeu
            console.log('[populateChampionSelects] Recebido para popular:', champions);

            // Verificação de segurança: garante que temos um array com campeões.
            if (!Array.isArray(champions) || champions.length === 0) {
                console.error('[populateChampionSelects] Nenhum campeão para popular. A lista está vazia ou não é um array.');
                return;
            }

            const sortedChampions = champions.sort((a, b) => a.name.localeCompare(b.name));
            championSelects.forEach(select => {
                select.innerHTML = ''; 
                const defaultOption = document.createElement('option');
                defaultOption.textContent = 'Selecione...';
                defaultOption.value = '';
                select.appendChild(defaultOption);
                sortedChampions.forEach(champion => {
                    const option = document.createElement('option');
                    option.value = champion.id;
                    option.textContent = champion.name;
                    select.appendChild(option);
                });
            });
            console.log(`[UI] Menus de campeões populados com ${champions.length} campeões.`);
        }

        function handleGameModeChange() {
            allConfigPanels.forEach(panel => panel.style.display = 'none');
            const selectedOption = gameModeSelect.options[gameModeSelect.selectedIndex];
            if (selectedOption) {
                const panelId = selectedOption.dataset.configPanel;
                if (panelId) {
                    const panelToShow = document.getElementById(panelId);
                    if (panelToShow) panelToShow.style.display = 'block';
                }
            }
        }

        function handleRoleSelection() {
            const primary = primaryRoleSelect.value;
            secondaryRoleSelect.disabled = (primary === 'FILL');
            Array.from(secondaryRoleSelect.options).forEach(opt => {
                opt.disabled = (opt.value === primary && primary !== 'FILL');
            });
        }
        
        function updateLcuUi(data) {
            if (!data) return;
            const isConnected = data.status === 'connected' || data.connected === true;
            lcuIndicator.classList.toggle('online', isConnected);
            lcuStatusText.textContent = isConnected ? 'Conectado' : 'Desconectado';
            allControls.forEach(control => {
                if (!control.closest('.ready-check-section')) {
                    control.disabled = !isConnected;
                }
            });
            if(isConnected) {
                handleGameModeChange();
                handleRoleSelection();
            }
        }

        function updateQueueUi(data) {
            const isInQueue = data.searchState === 'Searching';
            if (isInQueue) {
                if (!queueTimerInterval) {
                    queueSeconds = 0;
                    queueTimerInterval = setInterval(() => {
                        queueSeconds++;
                        queueStatusText.textContent = `Na Fila (${queueSeconds}s)`;
                    }, 1000);
                }
            } else {
                if (queueTimerInterval) {
                    clearInterval(queueTimerInterval);
                    queueTimerInterval = null;
                }
                queueStatusText.textContent = 'Inativa';
            }
            const isReadyCheckActive = readyCheckSection.style.display !== 'none';
            leaveQueueBtn.style.display = (isInQueue && !isReadyCheckActive) ? 'inline-block' : 'none';
            startQueueBtn.style.display = isInQueue ? 'none' : 'inline-block';
        }

        function updateReadyCheckUi(data) {
            const isReadyCheckActive = data.state === 'InProgress';
            controlsSection.style.display = isReadyCheckActive ? 'none' : 'block';
            readyCheckSection.style.display = isReadyCheckActive ? 'block' : 'none';
            if (isReadyCheckActive) {
                const timer = Math.floor(data.timer || 0);
                readyCheckTimer.textContent = `Tempo restante: ${timer}s`;
            }
        }

        // --- Registro de Eventos ---
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM carregado. Buscando status inicial e assets...');
            const initialLcuStatus = await window.api.getInitialLcuStatus();
            updateLcuUi(initialLcuStatus);
            if (initialLcuStatus?.connected) {
                console.log('[DOMContentLoaded] LCU já conectado, buscando campeões...');
                try {
                    const ownedChampions = await window.api.getOwnedChampions();
                    // Log para ver o que a API realmente retornou
                    console.log('[DOMContentLoaded] Campeões recebidos:', ownedChampions);
                    populateChampionSelects(ownedChampions);
                } catch (error) {
                    console.error('[DOMContentLoaded] Erro ao buscar campeões:', error);
                }
            }
        });

        window.api.onLcuStatusUpdate(async (data) => {
            updateLcuUi(data);
            if (data.status === 'connected') {
                console.log('[onLcuStatusUpdate] LCU recém-conectado, buscando campeões...');
                 try {
                    const ownedChampions = await window.api.getOwnedChampions();
                    // Log para ver o que a API realmente retornou
                    console.log('[onLcuStatusUpdate] Campeões recebidos:', ownedChampions);
                    populateChampionSelects(ownedChampions);
                } catch (error) {
                    console.error('[onLcuStatusUpdate] Erro ao buscar campeões:', error);
                }
            }
        });

        window.api.onQueueStatusUpdate(updateQueueUi);
        window.api.onReadyCheckUpdate(updateReadyCheckUi);
        
        gameModeSelect.addEventListener('change', handleGameModeChange);
        primaryRoleSelect.addEventListener('change', handleRoleSelection);
        secondaryRoleSelect.addEventListener('change', handleRoleSelection);
        
        startQueueBtn.addEventListener('click', () => {
            const queueId = parseInt(gameModeSelect.value, 10);
            
            // Monta a configuração base
            const config = {
                queueId: queueId,
                primaryRole: document.getElementById('primary-role-select').value,
                secondaryRole: document.getElementById('secondary-role-select').value,
            };

            // Se for Swiftplay ou Brawl, adiciona as seleções de campeão
            if (queueId === 490) { // Swiftplay
                config.selections = [
                    { championId: parseInt(document.getElementById('swiftplay-champ-1').value), position: document.getElementById('swiftplay-pos-1').value },
                    { championId: parseInt(document.getElementById('swiftplay-champ-2').value), position: document.getElementById('swiftplay-pos-2').value }
                ];
            } else if (queueId === 1700) { // Brawl
                 config.selections = [
                    { championId: parseInt(document.getElementById('brawl-champ-1').value), position: "UNSELECTED" } // Brawl não tem seleção de posição
                ];
            }
            window.api.invokeStartQueue(config);
        });

        leaveQueueBtn.addEventListener('click', () => window.api.invokeLeaveQueue());
        document.getElementById('accept-btn').addEventListener('click', () => window.api.invokeAcceptMatch());
        document.getElementById('decline-btn').addEventListener('click', () => window.api.invokeDeclineMatch());
    </script>
</body>
</html>
